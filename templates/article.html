{% extends "base.html" %}

{% block title %}{{ article.title }} | Luminary Blog{% endblock %}

{% block meta_description %}{{ article.summary }}{% endblock %}
{% block og_image %}{{ article.image if article.image.startswith('http') else url_for('static',
filename=article.image.replace('/static/', ''), _external=True) }}{% endblock %}

{% block scripts %}
<script>
    async function deletePost(postId) {
        if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
            return;
        }

        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        try {
            const response = await fetch(`/delete-post/${postId}`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                }
            });

            const data = await response.json();
            if (response.ok) {
                alert('Post deleted successfully.');
                window.location.href = "{{ url_for('articles') }}";
            } else {
                alert(data.error || 'Failed to delete post.');
            }
        } catch (error) {
            alert('An error occurred while deleting the post.');
        }
    }
</script>
{% endblock %}

{% block content %}
<article class="article-container">
    <header class="article-header">
        <span class="badge">{{ article.category }}</span>
        <h1>{{ article.title }}</h1>
        <div class="article-meta">
            <div class="author">
                <img src="{{ article.author.profile_pic if article.author.profile_pic else 'https://i.pravatar.cc/150?u=' + article.author.email }}"
                    alt="Author" class="author-img">
                <div class="author-info">
                    <span class="author-name">{{ article.author.name }}</span>
                    <span class="publish-date">{{ article.date }}</span>
                </div>
            </div>
            <div class="read-stats">
                <span>{{ article.read_time }}</span>
                <span class="dot"></span>
                <span>Active Reading</span>
            </div>
            {% if current_user.is_authenticated and current_user == article.author %}
            <div class="management-actions" style="margin-left: auto; display: flex; gap: 1rem;">
                <a href="{{ url_for('edit_post', post_id=article.id) }}" class="btn btn-small btn-outline"
                    style="text-decoration: none;">Edit Post</a>
                <button onclick="deletePost({{ article.id }})" class="btn btn-small"
                    style="background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.2);">Delete</button>
            </div>
            {% endif %}
        </div>
    </header>

    <div class="article-hero-image" style="background-image: url('{{ article.image }}')"></div>

    <div class="article-content">
        {{ article.content | safe }}
    </div>

    <footer class="article-footer">
        <div class="share-links">
            <span>Share:</span>
            <a href="#">Twitter</a>
            <a href="#">LinkedIn</a>
            <a href="#">Copy Link</a>
        </div>
        <div class="article-tags">
            <span class="tag">#{{ article.category }}</span>
            <span class="tag">#Luminary</span>
            <span class="tag">#Insights</span>
        </div>
    </footer>
</article>
{% endblock %}